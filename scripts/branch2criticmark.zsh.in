#!@ZSH@

set -x

CASILEDIR=$(cd "$(dirname $0)/../" && pwd)

BRANCH=${1}
FILE=${2}
WT=$(mktemp -d -u worktree-diff.XXXXXX)

# trap 'rm -rf ${WT}' EXIT SIGHUP SIGTERM

@GIT@ worktree prune > /dev/null
@GIT@ worktree add --detach ${WT} ${BRANCH} > /dev/null

pushd ${WT}
rm -rf ccm_toolkit
ln -sf ../ccm_toolkit ./

export SILE_PATH=~/projects/sile-typesetter/sile
export SILE=~/projects/sile-typesetter/sile/sile; alias sile="$SILE"
export CASILE=~/projects/sile-typesetter/casile/casile; alias casile="$CASILE"

${CASILE} -l tr make -- -B ${FILE}
popd

${CASILE} -l tr make -- -B ${FILE}
mv ${FILE} ${FILE}.orig

@GIT@ hash-object -w -- ${WT}/${FILE} | read A
@GIT@ hash-object -w -- ${FILE}.orig | read B

if @GIT@ diff ${A}..${B} --quiet; then
    @GIT@ show ${B}
else
    @GIT@ diff --no-color --word-diff -U99999 ${A}..${B} |
        @SED@ -e '1,5d' |
            @PERL@ -pn \
                -e 's/\[-[^\]]*?-\]\{\+([^\}]*?==.*?)\+\}/\1/g' |
            @SED@ \
                -e 's/\[-/{--/g' -e 's/-\]/--}/g' \
                -e 's/{+/{++/g' -e 's/+}/++}/g'
fi
