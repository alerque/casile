#!@ZSH@
set -e

source "${0:a:h}/functions.zsh"

alias git="@GIT@"
alias pandoc="@PANDOC@"
alias rg="@RG@"

: ${bookid:=$1}
test -n bookid

require_pristine_project ${bookid}*

pandoc_args=(
	--lua-filter=${0:a:h}/../pandoc-filters/chapterid.lua
)

# TODO: do we need turkish filename hacks back?
# $(SED) -n '/^#/{s/Ä±/i/g;p}' |

# TODO: finish and use related files finder?
# ${0:a:h}/list_related_files.zsh $bookid |

git ls-files "$bookid-*/*.md" |
	xargs rg --files-without-match loadchapters.zsh |
	while read file; do
		basename $file | IFS='[-.]' read no _
		dirname $file | read dir
		rg -m1 '^#' $file | pandoc ${pandoc_args[@]} | read identifier
		git mv -k "$file" "$dir/$no-$identifier.md"
	done

echo done

commit "Normalize $bookid filenames based on heading ids"
